<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Nook â€¢ Live Tracking</title>

  <!-- Leaflet (map UI) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="stylesheet" href="assets/style.css" />
  <script defer src="assets/icons.js"></script>

  <style>
    /* keep our layers always visible */
    .leaflet-pane.user-pane  { z-index: 650; }
    .leaflet-pane.route-pane { z-index: 640; }
  </style>
</head>
<body>
  <header class="appbar">Live tracking</header>

  <main id="app">
    <div id="map"></div>
    <button id="recenter" class="floating">â—Ž</button>

    <div class="panel">
      <div class="row">
        <div>
          <div class="label">To</div>
          <div id="destText">â€”</div>
        </div>
        <a class="ghost" href="index.html">Change</a>
      </div>

      <div class="stats">
        <div><span class="label">ETA</span><span id="eta">â€”</span></div>
        <div><span class="label">Distance</span><span id="dist">â€”</span></div>
        <div><span class="label">Speed</span><span id="speed">â€”</span></div>
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </main>

  <script>
    // ========== helpers ==========
    const $ = (s)=>document.querySelector(s);
    const destText=$("#destText"), etaEl=$("#eta"), distEl=$("#dist"), speedEl=$("#speed"), msg=$("#msg");
    const recenterBtn=$("#recenter");

    const params = new URLSearchParams(location.search);
    if(!params.has('dest')) location.replace('index.html');
    const [dlat, dlng] = params.get('dest').split(',').map(Number);
    const DEST = L.latLng(dlat, dlng);
    destText.textContent = `${DEST.lat.toFixed(5)}, ${DEST.lng.toFixed(5)}`;

    // ========== map ==========
    const map = L.map('map', { zoomControl:false }).setView(DEST, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    map.createPane('user-pane');
    map.createPane('route-pane');

    const youMarker = L.marker(DEST, { icon: window.NookIcons.user, pane: 'user-pane' }).addTo(map);
    const destMarker = L.marker(DEST, { icon: window.NookIcons.flag }).addTo(map);

    // Polyline = "polylineCoordinates" from the tutorial
    const routeLine = L.polyline([], { color:'#7B61FF', weight:6, opacity:1, pane:'route-pane' }).addTo(map);

    // ========== ROUTING (like getPolyPoints) ==========
    // try multiple public OSRM instances (same API) â€” no keys, all free
    const OSRM_SERVERS = [
      'https://router.project-osrm.org',
      'https://routing.openstreetmap.de/routed-car',
      'https://osrm-demo.maptiler.com' // public demo
    ];

    async function getRouteCoords(origin, dest) {
      // Returns an array of [lat, lng] just like polylineCoordinates
      let lastErr = null;
      for (const base of OSRM_SERVERS) {
        try {
          const url = `${base}/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=full&geometries=geojson`;
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status} @ ${new URL(url).host}`);
          const json = await res.json();
          if (!json.routes?.length) throw new Error('No route');
          return json.routes[0]; // { geometry, distance, duration }
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Routing failed');
    }

    async function drawRoute(origin, dest) {
      try {
        const r = await getRouteCoords(origin, dest);
        const coords = r.geometry.coordinates.map(([lng,lat]) => [lat,lng]); // to Leaflet [lat,lng]
        routeLine.setLatLngs(coords);

        const secs = Math.round(r.duration);
        const km = r.distance/1000;
        etaEl.textContent  = secs < 90 ? `${secs}s` : `${Math.round(secs/60)} min`;
        distEl.textContent = km < 1 ? `${Math.round(km*1000)} m` : `${km.toFixed(1)} km`;
        msg.textContent = km < 0.03 ? 'Arrived ðŸŽ‰' : '';
      } catch (e) {
        msg.textContent = 'Routing error: ' + (e.message || e);
      }
    }

    // ========== LIVE LOCATION (like getCurrentLocation) ==========
    let lastPos = null, follow = true;
    recenterBtn.addEventListener('click', ()=>{ follow = true; if (lastPos) map.setView(lastPos, 17, {animate:true}); });

    // throttle route recalcs (like calling setState only when needed)
    let lastRouteAt = 0;
    let lastRouted = null;
    function maybeRouteFrom(pos) {
      const now = Date.now();
      const movedEnough = !lastRouted || pos.distanceTo(lastRouted) > 15; // meters
      const cooledDown  = (now - lastRouteAt) > 2500;                    // ms
      if (movedEnough || cooledDown) {
        lastRouted = pos; lastRouteAt = now;
        drawRoute(pos, DEST);
      }
    }

    function seedAndWatch() {
      if (!('geolocation' in navigator)) { msg.textContent = 'Geolocation not supported.'; return; }

      // seed once (== first "currentLocation" in the Flutter post)
      navigator.geolocation.getCurrentPosition(
        (p)=> {
          lastPos = L.latLng(p.coords.latitude, p.coords.longitude);
          youMarker.setLatLng(lastPos);
          map.setView(lastPos, 16);
          maybeRouteFrom(lastPos);         // first route draw
          startWatch();                    // then begin real-time updates
        },
        (err)=> { msg.textContent = 'Location error: ' + err.message; },
        { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
      );
    }

    function startWatch() {
      navigator.geolocation.watchPosition(
        (p)=> {
          lastPos = L.latLng(p.coords.latitude, p.coords.longitude);
          youMarker.setLatLng(lastPos);

          const sp = p.coords.speed;
          speedEl.textContent = (typeof sp === 'number' && !Number.isNaN(sp))
            ? `${Math.max(0, sp*3.6).toFixed(1)} km/h`
            : 'â€”';

          maybeRouteFrom(lastPos);
          if (follow) map.setView(lastPos, 17);
          follow = false;
        },
        (err)=> { msg.textContent = 'Location error: ' + err.message; },
        { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
      );
    }

    seedAndWatch();
  </script>
</body>
</html>
